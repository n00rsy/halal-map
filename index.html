<!DOCTYPE html>
<html>

<head>
    <title>Halal Map</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBeQvkyGVlDbl91fEjxMBfgSwK7hIP4Slk&loading=async&callback=initMap&libraries=marker">
        </script>
    <script>
        let map;
        let locationsData = [];
        let fuse;
        let currentSortColumn = '';
        let currentSortDirection = 'asc';
        let markersMap = new Map(); // Store markers by location identifier
        let infoWindowsMap = new Map(); // Store info windows by location identifier
        let currentInfoWindow = null; // Track currently open info window

        // Pagination variables
        let currentPage = 1;
        const itemsPerPage = 20;
        let filteredData = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 4,
                center: { lat: 40.6683491, lng: -97.6131147 },
                gestureHandling: "greedy",
                streetViewControl: false,
                mapTypeControl: false,
                mapId: "HALAL_MAP"
            });
            fetch('locations.json')
                .then(response => response.json())
                .then(data => {
                    locationsData = data['places'];
                    // Initialize Fuse.js for fuzzy search
                    fuse = new Fuse(locationsData, {
                        keys: ['name', 'address', 'state', 'phone', 'certification'],
                        threshold: 0.3,
                        includeScore: true
                    });

                    // Populate the table
                    populateTable(locationsData);

                    data['places'].forEach(function (place) {
                        const glyphImg = document.createElement("img");
                        glyphImg.style.width = "10px"
                        glyphImg.src = "resturaunt.svg"
                        const glyphSvgPinElement = new google.maps.marker.PinElement({
                            glyph: glyphImg,
                        });

                        let marker = new google.maps.marker.AdvancedMarkerElement({
                            position: { lat: place.lat, lng: place.lng },
                            map: map,
                            title: place.name,
                            content: glyphSvgPinElement.element,
                        });
                        let identifier = place.nav_url.substring(48).replace(/[^a-zA-Z0-9]/g, '');

                        // Store marker reference
                        markersMap.set(identifier, marker);
                        let content = `
                        <div class="card border-0" style="max-width: 23rem;">
                            <button type="button" title="Close" id="close-btn-${identifier}" class="close" aria-label="Close" style="border: none; background: none; outline: none; position: absolute; top: 10px; right: 10px;">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <div class="card-body">
                                <h4 class="card-title">${place.name}</h3>
                                <h6 class="card-subtitle mb-2 text-muted">Certification: ${place.certification}
                                `
                        if (place.expires && isDatePast(place.expires)) {
                            content += `<span class="badge badge-danger">Expired</span>
                                `
                        }
                        content += `</h6>
                                <br>
                                <p><b>Address:</b> ${place.address}</p>`
                        if (place.phone) {
                            content += `<p><b>Phone:</b> <a href="tel:${place.phone}"> ${place.phone}</a></p>`
                        }
                        if (place.products) {
                            content += `<p><b>Products:</b>`
                            place.products.forEach(product => {
                                content += `<span class="badge badge-success">${product}</span>
                                `
                            })
                            content += `</p>`
                        }
                        if (place.expires) {
                            content += `<p><b>Expires:</b> ${formatDate(place.expires)}</p>`
                        }
                        if (place.website) {
                            content += `<a href="${place.website}" target="_blank" class="btn btn-outline-secondary btn-block">Website</a>
                        `
                        }
                        content += `<a href="${place.nav_url}" target="_blank" class="btn btn-primary btn-block">Navigate</a>
                        `
                        content += `</div></div>`
                        let infoWindow = new google.maps.InfoWindow({
                            content: content,
                            headerDisabled: true
                        });

                        // Store info window reference
                        infoWindowsMap.set(identifier, infoWindow);

                        google.maps.event.addListenerOnce(infoWindow, 'domready', function () {
                            document.getElementById(`close-btn-${identifier}`).addEventListener('click', function () {
                                infoWindow.close();
                                currentInfoWindow = null;
                            });
                        })

                        marker.addListener('click', function () {
                            if (currentInfoWindow) {
                                currentInfoWindow.close();
                            }
                            if (currentInfoWindow == infoWindow) {
                                currentInfoWindow = null
                            }
                            else {
                                infoWindow.open(map, marker);
                                currentInfoWindow = infoWindow;
                            }
                        });
                    });
                    document.getElementById('last-updated').innerText = `Last updated: ${data['updated']}`
                })
                .catch(error => {
                    console.error('Error fetching JSON data:', error);
                });
            getCurrentLocation()
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const day = date.getDate();
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();

            // Format the date as "Mon DD, YYYY"
            return `${month} ${day}, ${year}`;
        }

        function isDatePast(dateString) {
            const currentDate = new Date().toISOString().split(".")[0];
            return dateString < currentDate;
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    let currentPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    const pinGlyph = new google.maps.marker.PinElement({
                        glyphColor: "white",
                        background: "blue",
                        borderColor: "#00008B"
                    });
                    const markerViewGlyph = new google.maps.marker.AdvancedMarkerElement({
                        map,
                        position: currentPos,
                        content: pinGlyph.element,
                        title: "Your Location",
                    });
                    map.setCenter(currentPos);
                    map.setZoom(10)
                },
                    (error) => {
                        console.log(error.message)
                    });
            }
        }

        function populateTable(data) {
            // Store the filtered data for pagination
            filteredData = data;

            // Calculate pagination
            const totalPages = Math.ceil(data.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            const tableBody = document.getElementById('locations-table-body');
            tableBody.innerHTML = '';

            paginatedData.forEach(location => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.title = 'Click to view on map';

                // Create identifier for this location (same as used in marker creation)
                const identifier = location.nav_url.substring(48).replace(/[^a-zA-Z0-9]/g, '');

                // Add click handler to show location on map and open info window
                row.addEventListener('click', () => {
                    map.setCenter({ lat: location.lat, lng: location.lng });
                    map.setZoom(15);

                    // Close any currently open info window
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }

                    // Open the info window for this location
                    const marker = markersMap.get(identifier);
                    const infoWindow = infoWindowsMap.get(identifier);

                    if (marker && infoWindow) {
                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                    }

                    // Scroll to top to show the map
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });

                // Name
                const nameCell = document.createElement('td');
                if (location.website) {
                    const nameLink = document.createElement('a');
                    nameLink.href = location.website;
                    nameLink.target = '_blank';
                    nameLink.textContent = location.name;
                    nameLink.style.color = '#007bff';
                    nameLink.style.textDecoration = 'none';
                    // Prevent row click when clicking the name link
                    nameLink.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                    nameCell.appendChild(nameLink);
                } else {
                    nameCell.textContent = location.name;
                }
                row.appendChild(nameCell);

                // Certification
                const certificationCell = document.createElement('td');
                certificationCell.textContent = location.certification || 'N/A';
                row.appendChild(certificationCell);

                // Address
                const addressCell = document.createElement('td');
                addressCell.textContent = location.address;
                row.appendChild(addressCell);

                tableBody.appendChild(row);
            });

            // Update results count and pagination
            updateResultsCount(data.length, paginatedData.length);
            updatePaginationControls(totalPages);
        }

        function updateResultsCount(totalCount, displayedCount) {
            const countElement = document.getElementById('results-count');
            if (countElement) {
                if (totalCount === displayedCount) {
                    countElement.textContent = `Showing ${totalCount} restaurant${totalCount !== 1 ? 's' : ''}`;
                } else {
                    const startIndex = (currentPage - 1) * itemsPerPage + 1;
                    const endIndex = Math.min(currentPage * itemsPerPage, totalCount);
                    countElement.textContent = `Showing ${startIndex}-${endIndex} of ${totalCount} restaurant${totalCount !== 1 ? 's' : ''}`;
                }
            }
        }

        function updatePaginationControls(totalPages) {
            const paginationElement = document.getElementById('pagination-controls');
            if (!paginationElement) return;

            paginationElement.innerHTML = '';

            if (totalPages <= 1) {
                paginationElement.style.display = 'none';
                return;
            }

            paginationElement.style.display = 'flex';

            // Previous button
            const prevButton = document.createElement('button');
            prevButton.className = `btn btn-sm ${currentPage === 1 ? 'btn-secondary disabled' : 'btn-outline-primary'}`;
            prevButton.innerHTML = '&laquo;';
            prevButton.title = 'Previous';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    populateTable(filteredData);
                }
            };
            paginationElement.appendChild(prevButton);

            // Calculate which page numbers to show (max 3: previous, current, next)
            const pagesToShow = [];

            // Always include current page
            pagesToShow.push(currentPage);

            // Add previous page if exists
            if (currentPage > 1) {
                pagesToShow.unshift(currentPage - 1);
            }

            // Add next page if exists
            if (currentPage < totalPages) {
                pagesToShow.push(currentPage + 1);
            }

            // Create page number buttons
            pagesToShow.forEach(pageNum => {
                const pageButton = document.createElement('button');
                pageButton.className = `btn btn-sm ${pageNum === currentPage ? 'btn-primary' : 'btn-outline-primary'}`;
                pageButton.textContent = pageNum;
                pageButton.onclick = () => {
                    currentPage = pageNum;
                    populateTable(filteredData);
                };
                paginationElement.appendChild(pageButton);
            });

            // Next button
            const nextButton = document.createElement('button');
            nextButton.className = `btn btn-sm ${currentPage === totalPages ? 'btn-secondary disabled' : 'btn-outline-primary'}`;
            nextButton.innerHTML = '&raquo;';
            nextButton.title = 'Next';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    populateTable(filteredData);
                }
            };
            paginationElement.appendChild(nextButton);
        }

        function filterTable() {
            const searchInput = document.getElementById('search-input').value.trim();

            // Reset to first page when filtering
            currentPage = 1;

            if (searchInput === '') {
                populateTable(locationsData);
                return;
            }

            const results = fuse.search(searchInput);
            const filteredData = results.map(result => result.item);
            populateTable(filteredData);
        }

        function sortTable(column) {
            // Reset to first page when sorting
            currentPage = 1;

            // Toggle sort direction if clicking the same column
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortDirection = 'asc';
                currentSortColumn = column;
            }

            // Update sort indicators
            updateSortIndicators(column);

            const searchInput = document.getElementById('search-input').value.trim();
            let dataToSort;

            if (searchInput === '') {
                dataToSort = [...locationsData];
            } else {
                const results = fuse.search(searchInput);
                dataToSort = results.map(result => result.item);
            }

            dataToSort.sort((a, b) => {
                let aValue = a[column] || '';
                let bValue = b[column] || '';

                if (typeof aValue === 'string') {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }

                if (currentSortDirection === 'asc') {
                    return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
                } else {
                    return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
                }
            });

            populateTable(dataToSort);
        }

        function updateSortIndicators(column) {
            // Remove all existing sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.textContent = '';
            });

            // Add sort indicator to current column
            const indicator = document.getElementById(`sort-${column}`);
            if (indicator) {
                indicator.textContent = currentSortDirection === 'asc' ? ' ‚Üë' : ' ‚Üì';
            }
        }
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8HKTYQ2VP1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-8HKTYQ2VP1');
    </script>
    <style>
        #map {
            height: 75vh;
            margin-top: 15px;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .sort-indicator {
            font-size: 0.8em;
            color: #007bff;
        }

        .table th {
            user-select: none;
        }

        .table th:hover {
            background-color: #495057;
        }

        .table tbody tr:hover {
            background-color: #e3f2fd !important;
            cursor: pointer;
        }

        .table tbody td a:hover {
            text-decoration: underline !important;
        }

        #search-input {
            max-width: 100%;
        }

        .table-responsive {
            height: 600px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .table-responsive {
                height: 400px;
            }
        }

        #pagination-controls {
            gap: 0.25rem;
        }

        #pagination-controls .btn {
            min-width: 35px;
            height: 32px;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.2;
            border-radius: 0.25rem;
        }

        #pagination-controls .btn:first-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        #pagination-controls .btn:last-child {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        #pagination-controls .btn:not(:first-child):not(:last-child) {
            border-radius: 0;
            border-left: 0;
        }

        #pagination-controls .btn+.btn {
            margin-left: -1px;
        }

        @media (max-width: 767px) {
            .mobile-spacing {
                margin-top: 0.75rem;
            }
        }
        /* Sticky table header */
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #343a40;
            border-top: none;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Halal Map</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent"
            aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active" id="map-tab">
                    <a class="nav-link" href="#" onclick="showTab('map-content')">Map</a>
                </li>
                <li class="nav-item" id="about-tab">
                    <a class="nav-link" href="#" onclick="showTab('about-content')">About</a>
                </li>
            </ul>
            <button id="getCurrentLocationButton" class="btn btn-outline-success my-2 my-sm-0"
                onclick="getCurrentLocation()">Locate Me!</button>
        </div>
    </nav>
    <div class="container">
        <div id="map-content">
            <div class="mt-4">
                <h1>USA Halal Certified Restaurants</h1>
                <p>Click on the pins to explore!</p>
            </div>

            <div id="map"></div>

            <!-- Locations Table Section -->
            <div class="mt-4">
                <h2>Restaurant Locations</h2>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" id="search-input" class="form-control"
                            placeholder="Search by name, address, city, state, phone, or certification..."
                            onkeyup="filterTable()">
                    </div>
                    <div class="col-md-6 d-flex align-items-center mobile-spacing">
                        <small class="text-muted ml-3">üí° Click any row to view location on map</small>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col" style="cursor: pointer;" onclick="sortTable('name')">
                                    Name<span id="sort-name" class="sort-indicator"></span>
                                </th>
                                <th scope="col" style="cursor: pointer;" onclick="sortTable('certification')">
                                    Certification<span id="sort-certification" class="sort-indicator"></span>
                                </th>
                                <th scope="col">
                                    Address
                                </th>
                            </tr>
                        </thead>
                        <tbody id="locations-table-body">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div id="pagination-controls" class="d-flex justify-content-center align-items-center mt-3"
                    style="display: none;"></div>
            </div>
            <small id="results-count" class="text-muted">Loading...</small>
            <br>
            <small id="last-updated" class="text-muted">Last updated:</small>

        </div>
        <div id="about-content" style="display: none;">
            <div class="mt-4">
                <h1>About Halal Map</h1>
                <br>
                <h3>Find Halal-Certified Restaurants Near You üçî</h3>
                <p>
                    This map pulls the latest data from HMS (Halal Monitoring Services) and HFSAA (Halal Food
                    Standards
                    Alliance of America) daily, ensuring that you have up-to-date information on certified Halal
                    restaurants across the U.S. Simply click on the pins to explore!
                </p>

                <h4>What is Halal? ü§î</h4>
                <p>
                    In regards to food, Halal refers to the set of standards that deem a product permissible under
                    Islamic law. This includes specific guidelines
                    for how animals are slaughtered, how food is prepared, and ensuring the absence of prohibited
                    ingredients like pork or alcohol.
                </p>

                <h4>About HMS and HFSAA ‚ÑπÔ∏è</h4>
                <p><strong>HMS (Halal Monitoring Services):</strong> a non-profit branch of the Shariah Board of
                    America, is run by an independent team of experienced Ulama, certifying and monitoring
                    hand-slaughtered Halal meat across the supply chain in over 13 U.S. states, ensuring adherence
                    to
                    Zabiha Halal principles and offering its services free of charge since 2005.</p>
                <p><strong>HFSAA (Halal Food Standards Alliance of America):</strong> a non-profit Halal
                    certification
                    organization that ensures a high standard of Halal compliance across the entire supply chain,
                    including meat, foods, cosmetics, and chemicals, accommodating various Islamic views on Halal.
                    With
                    extensive research across 15 U.S. states and multiple countries, HFSAA certifies practices such
                    as
                    hand slaughter by Muslim slaughterers, Tasmiya on each animal, and ensures non-meat products are
                    free of most alcohol and animal byproducts.</p>

                <h4>Verifying Certification</h4>
                <p>
                    <strong>Check for Certification Labels:</strong> Look for visible HMS or HFSAA certification
                    labels at the establishment.
                </p>
                <p>
                    <strong>Visit Official Websites:</strong> For the most current information, visit the <a
                        href="https://www.hmsusa.org/certified-listing.html">HMS website</a> or the <a
                        href="https://www.hfsaa.org/restaurants/">HFSAA website</a>.
                </p>

                <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js"
                    data-name="bmc-button" data-slug="n00rsy" data-color="#40DCA5" data-emoji="‚òï" data-font="Cookie"
                    data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#ffffff"
                    data-coffee-color="#FFDD00"></script>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script>
        function showTab(tabId) {
            // Hide all content
            document.getElementById('map-content').style.display = 'none';
            document.getElementById('about-content').style.display = 'none';

            // Show selected content
            document.getElementById(tabId).style.display = 'block';

            // Update active tab
            document.getElementById('map-tab').classList.remove('active');
            document.getElementById('about-tab').classList.remove('active');

            if (tabId === 'map-content') {
                document.getElementById('map-tab').classList.add('active');
            } else if (tabId === 'about-content') {
                document.getElementById('about-tab').classList.add('active');
            }
        }
    </script>
</body>

</html>